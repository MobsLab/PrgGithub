% PSTH_behav_Movtsd2

% similar to PSTH_behav_Movtsd, but plot 
% - either all CS +, averaged_2_by_2
% - or the first 4 CS +, no averaged


%%% for all CS +, averaged_2_by_2
% CSoption = 'AllCS avg2by2';
% disp ('CSoption = AllCS avg2by2')

%%% for first 4 CS +, no averaged
CSoption = '4firstCS not averaged';
disp ('CSoption = 4firstCS not averaged')


% 14.11.2016
% from PSTH_behav bescause uses accelero data (more reliable than video
% tracking since cables generate artfacts)

% 22.08.2015
% from FigBILANObsFreez_Nov15

% 09.12.2015
% different way to get TTL

% 23.12.2014 aims at giving an overview of the behavioral results of Fear Conditionning(oct-nov2014)

% INPUTS
% manipname : 'ManipDec14Bulbectomie' or 'ManipFeb15Bulbectomie' -> define name of EXT 24h and mice names
% smoothing : parameter for SmoothDec
% plo : if =1  individual plot are created (time consuming)

% OUTPUTS
% a figure for each mouse of PSTH (averaged CS-, first CS+, last CS+) ->  BulbectomiePSTHdata.mat
% a matrix for all mice of PSTH (averaged CS-, first CS+, last CS+) color coded)
% the average of these matrices by group (sham/ bulb)
% the compartison of Pre/Post sound period by group 

% e.g. Marie: FigBILANObsFreez('Marie','FearMLavr2015','smoothing',1);


% %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% %%%%%%%%%%%%%%%%%%  INPUTS  %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

experiment= 'Fear-electrophy-opto';
manipname='LaserChR2-fear';


cd /media/DataMOBsRAIDN/ProjetAversion/DATA-Fear/
res=pwd;
Dir=PathForExperimentFEAR('Fear-electrophy-opto');
Dir = RestrictPathForExperiment(Dir,'nMice',[363 367 458 459]);
[nameMice, IXnameMice]=unique(Dir.name);
 
lim=160; % nb bins
bi=1000; % bin size
smo=1;
plo=1;
sav=1;

FolderPath='/media/DataMOBsRAIDN/ProjetAversion/DATA-Fear/';

StepName={'EXT-24';'EXT-48';'EXT-72'};
%ColorPSTH={ [0.3 0 0],[1 0 0],[0 0 1]};% [1 0.5 0]
ColorPSTH={ [0.7 0.7 1],[1 0 0],[0 0 1],[1 0.7 0.7]};% [1 0.5 0]

% group CS+=bip
CSplu_bip_GpNb=[];
CSplu_bip_Gp={};
for k=1:length(CSplu_bip_GpNb)
    CSplu_bip_Gp{k}=num2str(CSplu_bip_GpNb(k));
end
CSplu_bip_Gp=CSplu_bip_Gp';

% group CS+=WN
CSplu_WN_GpNb=[363 367 458 459];
CSplu_WN_Gp={};
for k=1:length(CSplu_WN_GpNb)
    CSplu_WN_Gp{k}=num2str(CSplu_WN_GpNb(k));
end
CSplu_WN_Gp=CSplu_WN_Gp';

%% GET DATA TO PLOT
try
    load(['MovtsdPSTH_ChR2/PSTH_behav_' manipname ]);
    disp(['Loading existing data from PSTH_behav_' manipname '.mat']);
    [B,IX] = sort(Dir.group);
    Dir.path=Dir.path(IX);
    Dir.name=Dir.name(IX);
    Dir.manipe=Dir.manipe(IX);
    Dir.group=B;
    Dir.Session=Dir.Session(IX);
    [nameMice, IXnameMice]=unique(Dir.name);

catch

    % Matrix of data; mice in lines
    % EXT24
    C0=[]; % CS- no laser
    C1=[]; % CS- with laser 
    C2=[]; % CS+ no laser    
    C3=[]; % CS+ with laser
    C4=[]; % CS+ no laser    
    C5=[]; % CS+ with laser
    C6=[]; % CS+ no laser    
    C7=[]; % CS+ with laser
    % EXT-48
    P0=[];P1=[];P2=[];P3=[];P4=[];P5=[];P6=[];P7=[];
    % EXT-72
    E0=[];E1=[];E2=[];E3=[];E4=[];E5=[];E6=[];E7=[];
    C={};P={};E={};
    a=1; %counter for MouseList COND
    
    i=1;
    Mousename='MXXX';
    for man=1:length(Dir.path) 
        
        Mousename=['M' Dir.name{man}(end-2:end)];
        MouseListC{a}=Mousename;
        disp(Mousename)
        a=a+1;
        
        cd ([Dir.path{man}])
        load ('behavResources.mat', 'Movtsd','TTL')

        DiffTimes=diff(TTL(:,1));
        ind=DiffTimes>2;
        times=TTL(:,1);
        event=TTL(:,2);
        CStimes=times([1; find(ind)+1]);  %temps du premier TTL de chaque s�rie de son
        CSevent=event([1; find(ind)+1]);  %valeur du premier TTL de chaque s�rie de son (CS+ ou CS-)

        %d�finir CS+ et CS- selon les groupes
        m=Mousename(2:4);
       if sum(strcmp(num2str(m),CSplu_bip_Gp))==1
            CSpluCode=4; %bip
            CSminCode=3; %White Noise
        elseif sum(strcmp(num2str(m),CSplu_WN_Gp))==1
            CSpluCode=3;
            CSminCode=4;
        end

        csp=CStimes(CSevent==CSpluCode);
        csm=CStimes(CSevent==CSminCode);
        
        % 0 : CS- laser OFF; 1 : CS- laser ON; 2 : CS+ laser OFF; 3 : CS+ laser ON
        if isempty(strfind(Dir.path{man}, 'HABgrille')) % EXT-24
            
            if strcmp(CSoption, 'AllCS avg2by2')
                try
                [m0,s0,t0]=mETAverage(csm([1 3])*1E4,Range(Movtsd),Data(Movtsd),bi,lim);
                [m1,s1,t1]=mETAverage(csm([2 4])*1E4,Range(Movtsd),Data(Movtsd),bi,lim);
                [m2,s2,t2]=mETAverage(csp(1:2:3)*1E4,Range(Movtsd),Data(Movtsd),bi,lim);% un son sur 2 laser 0FF (en commencant par OFF)
                [m3,s3,t3]=mETAverage(csp(2:2:4)*1E4,Range(Movtsd),Data(Movtsd),bi,lim);% un son sur 2 laser ON 

                [m4,s4,t4]=mETAverage(csp(5:2:7)*1E4,Range(Movtsd),Data(Movtsd),bi,lim);% un son sur 2 laser 0FF (en commencant par OFF)
                [m5,s5,t5]=mETAverage(csp(6:2:8)*1E4,Range(Movtsd),Data(Movtsd),bi,lim);% un son sur 2 laser ON 
                [m6,s6,t6]=mETAverage(csp(9:2:11)*1E4,Range(Movtsd),Data(Movtsd),bi,lim);% un son sur 2 laser 0FF (en commencant par OFF)
                [m7,s7,t7]=mETAverage(csp(10:2:12)*1E4,Range(Movtsd),Data(Movtsd),bi,lim);% un son sur 2 laser ON 

                catch
                    if strcmp(Dir.path{man},'/media/DataMOBsRAIDN/ProjetAversion/DATA-Fear/Mouse459/20161019-EXT-24h-laser10')
                        [m2,s2,t2]=mETAverage(csp(1)*1E4,Range(Movtsd),Data(Movtsd),bi,lim);% un son sur 2 laser 0FF (en commencant par OFF)
                        [m3,s3,t3]=mETAverage(csp(2)*1E4,Range(Movtsd),Data(Movtsd),bi,lim);% un son sur 2 laser ON     
                        [m1,s1,t1]=mETAverage(csm([2 4])*1E4,Range(Movtsd),Data(Movtsd),bi,lim);
                        [m0,s0,t0]=mETAverage(csm([1 3])*1E4,Range(Movtsd),Data(Movtsd),bi,lim);
                        m4=nan(size(m2)); s4=nan(size(s2)); t4=t2;
                        m5=nan(size(m2)); s5=nan(size(s2)); t5=t2;
                        m6=nan(size(m2)); s6=nan(size(s2)); t6=t2;
                        m7=nan(size(m2)); s7=nan(size(s2)); t7=t2;
                    else
                        keyboard
                    end
                end   

            elseif strcmp(CSoption, '4firstCS not averaged')
                try
                    [m0,s0,t0]=mETAverage(csm(1)*1E4,Range(Movtsd),Data(Movtsd),bi,lim);
                    [m1,s1,t1]=mETAverage(csm(2)*1E4,Range(Movtsd),Data(Movtsd),bi,lim);
                    [m2,s2,t2]=mETAverage(csm(3)*1E4,Range(Movtsd),Data(Movtsd),bi,lim);
                    [m3,s3,t3]=mETAverage(csm(4)*1E4,Range(Movtsd),Data(Movtsd),bi,lim);

                    [m4,s4,t4]=mETAverage(csp(1)*1E4,Range(Movtsd),Data(Movtsd),bi,lim);% un son sur 2 laser 0FF (en commencant par OFF)
                    [m5,s5,t5]=mETAverage(csp(2)*1E4,Range(Movtsd),Data(Movtsd),bi,lim);% un son sur 2 laser ON 
                    [m6,s6,t6]=mETAverage(csp(3)*1E4,Range(Movtsd),Data(Movtsd),bi,lim);% un son sur 2 laser 0FF (en commencant par OFF)
                    [m7,s7,t7]=mETAverage(csp(4)*1E4,Range(Movtsd),Data(Movtsd),bi,lim);% un son sur 2 laser 0FF (en commencant par OFF)
                catch
                    if strcmp(Dir.path{man},'/media/DataMOBsRAIDN/ProjetAversion/DATA-Fear/Mouse459/20161019-EXT-24h-laser10')
                        m6=nan(size(m2)); s6=nan(size(s2)); t6=t2;
                        m7=nan(size(m2)); s7=nan(size(s2)); t7=t2;
                    end
                end
            end
            
        end

        if ~isempty(strfind(Dir.path{man}, StepName{1})) % EXT-24
            disp(StepName{1})
            C0=[C0,m0];
            C1=[C1,m1];
            C2=[C2,m2];
            C3=[C3,m3];
            
            C4=[C4,m4];
            C5=[C5,m5];
            C6=[C6,m6];
            C7=[C7,m7];
            
            C{i}.m0=m0;C{i}.s0=s0;C{i}.t0=t0;
            C{i}.m1=m1;C{i}.s1=s1;C{i}.t1=t1;
            C{i}.m2=m2;C{i}.s2=s2;C{i}.t2=t2;
            C{i}.m3=m3;C{i}.s3=s3;C{i}.t3=t3;
            
            C{i}.m4=m4;C{i}.s4=s4;C{i}.t4=t4;
            C{i}.m5=m5;C{i}.s5=s5;C{i}.t5=t5;
            C{i}.m6=m6;C{i}.s6=s6;C{i}.t6=t6;
            C{i}.m7=m7;C{i}.s7=s7;C{i}.t7=t7;
            
        elseif ~isempty(strfind(Dir.path{man}, StepName{2})) % EXT-48
            disp(StepName{2})
            
            P0=[P0,m0];
            P1=[P1,m1];
            P2=[P2,m2];
            P3=[P3,m3];
            
            P4=[P4,m4];
            P5=[P5,m5];
            P6=[P6,m6];
            P7=[P7,m7];

            P{i}.m0=m0;P{i}.s0=s0;P{i}.t0=t0;
            P{i}.m1=m1;P{i}.s1=s1;P{i}.t1=t1;
            P{i}.m2=m2;P{i}.s2=s2;P{i}.t2=t2;
            P{i}.m3=m3;P{i}.s3=s3;P{i}.t3=t3;
            
            P{i}.m4=m4;P{i}.s4=s4;P{i}.t4=t4;
            P{i}.m5=m5;P{i}.s5=s5;P{i}.t5=t5;
            P{i}.m6=m6;P{i}.s6=s6;P{i}.t6=t6;
            P{i}.m7=m7;P{i}.s7=s7;P{i}.t7=t7;
            
        elseif ~isempty(strfind(Dir.path{man}, StepName{3})) % EXT-72
            disp(StepName{3})
            
            E2=[E2,m2];
            E3=[E3,m3];
            E1=[E1,m1];
            E0=[E0,m0];

            E4=[E4,m4];
            E5=[E5,m5];
            E6=[E6,m6];
            E7=[E7,m7];
            
            E{i}.m2=m2;E{i}.s2=s2;E{i}.t2=t2;
            E{i}.m1=m1;E{i}.s1=s1;E{i}.t1=t1;
            E{i}.m3=m3;E{i}.s3=s3;E{i}.t3=t3;
            E{i}.m0=m0;E{i}.s0=s0;E{i}.t0=t0;
            
            E{i}.m4=m4;E{i}.s4=s4;E{i}.t4=t4;
            E{i}.m5=m5;E{i}.s5=s5;E{i}.t5=t5;
            E{i}.m6=m6;E{i}.s6=s6;E{i}.t6=t6;
            E{i}.m7=m7;E{i}.s7=s7;E{i}.t7=t7;
            
        end

        if man<length(Dir.path)
            if strcmp(Dir.name{man+1}(end-2:end),Dir.name{man}(end-2:end))% same mouse, following recording
            else
                i=i+1;
            end
        end
    end
    
    clear m0 s0 t0 m1 s1 t1 m2 s2 t2 m3 s3 t3 m4 s4 t4 m5 s5 t5 m6 s6 t6 m7 s7 t7
    
    cd(res)
    disp(['Saving data in local path' ]);
    if ~isdir([ res '/MovtsdPSTH_ChR2'])
        mkdir([ res '/MovtsdPSTH_ChR2']);
    end
    save ([res '/MovtsdPSTH_ChR2/PSTH_behav_' manipname  ],'C','P','E', 'C0','C1','C2', 'C3','C4','C5','C6','C7','P0','P1','P2','P3','P3','P4','P5','P6','P7','E0','E1','E2','E3','C3','E4','E5','E6','E7',...
        'csm','csp','CStimes','CSevent','times','event','MouseListC','TTL','StepName','ColorPSTH')

end % end of catch


%% PLOT DATA
Mousename='MXXX';
a=1;
if plo
    for i=1:length(nameMice), allfig(i)=figure('Color',[1 1 1],'Position', [1000 80 560 900]);end
    i=1;
    for man=1:length(Dir.path) 
        ind_mark=strfind(Dir.path{man},'/');
        figure(allfig(i))

        Mousename=['M' Dir.name{man}(end-2:end)];
        MouseListC{a}=Mousename;
        a=a+1;
        if ~isempty(strfind(Dir.path{man}, StepName{1})) % EXT-24
            subplot(3,1,1),hold on
            m2=C{i}.m2;s2=C{i}.s2;t2=C{i}.t2;
            m1=C{i}.m1;s1=C{i}.s1;t1=C{i}.t1;
            m3=C{i}.m3;s3=C{i}.s3;t3=C{i}.t3;
            m0=C{i}.m0;s0=C{i}.s0;t0=C{i}.t0;
            
            m4=C{i}.m4;s4=C{i}.s4;t4=C{i}.t4;
            m5=C{i}.m5;s5=C{i}.s5;t5=C{i}.t5;
            m6=C{i}.m6;s6=C{i}.s6;t6=C{i}.t6;
            m7=C{i}.m7;s7=C{i}.s7;t7=C{i}.t7;
            
        elseif ~isempty(strfind(Dir.path{man}, StepName{2})) % EXT-48
            subplot(3,1,2),hold on
            m2=P{i}.m2;s2=P{i}.s2;t2=P{i}.t2;
            m1=P{i}.m1;s1=P{i}.s1;t1=P{i}.t1;
            m3=P{i}.m3;s3=P{i}.s3;t3=P{i}.t3;
            m0=P{i}.m0;s0=P{i}.s0;t0=P{i}.t0;
            
            m4=P{i}.m4;s4=P{i}.s4;t4=P{i}.t4;
            m5=P{i}.m5;s5=P{i}.s5;t5=P{i}.t5;
            m6=P{i}.m6;s6=P{i}.s6;t6=P{i}.t6;
            m7=P{i}.m7;s7=P{i}.s7;t7=P{i}.t7;
            
        elseif ~isempty(strfind(Dir.path{man}, StepName{3})) % EXT-72
            subplot(3,1,3),hold on
            m2=E{i}.m2;s2=E{i}.s2;t2=E{i}.t2;
            m1=E{i}.m1;s1=E{i}.s1;t1=E{i}.t1;
            m3=E{i}.m3;s3=E{i}.s3;t3=E{i}.t3;
            m0=E{i}.m0;s0=E{i}.s0;t0=E{i}.t0;
            
            m4=E{i}.m4;s4=E{i}.s4;t4=E{i}.t4;
            m5=E{i}.m5;s5=E{i}.s5;t5=E{i}.t5;
            m6=E{i}.m6;s6=E{i}.s6;t6=E{i}.t6;
            m7=E{i}.m7;s7=E{i}.s7;t7=E{i}.t7;
           
        end
            %attention erreur de sqrt à corriger dans PSTH_behav_accelero.m
            H=shadedErrorBar(t0/1E3,SmoothDec(m0,smo),SmoothDec(s0/sqrt(2),smo),{'Color',ColorPSTH{4},'Linewidth',2},1);
            H=shadedErrorBar(t1/1E3,SmoothDec(m1,smo),SmoothDec(s1/sqrt(2),smo),{'Color',ColorPSTH{1},'Linewidth',2},1);
            set(get(get(H.mainLine,'Annotation'),'LegendInformation'),'IconDisplayStyle','off');
            set(get(get(H.patch,'Annotation'),'LegendInformation'),'IconDisplayStyle','off');
            set(get(get(H.edge(1),'Annotation'),'LegendInformation'),'IconDisplayStyle','off');
            set(get(get(H.edge(2),'Annotation'),'LegendInformation'),'IconDisplayStyle','off');
            H=shadedErrorBar(t2/1E3,SmoothDec(m2,smo),SmoothDec(s2/sqrt(2),smo),{'Color',ColorPSTH{2},'Linewidth',2},1);
            H=shadedErrorBar(t3/1E3,SmoothDec(m3,smo),SmoothDec(s3/sqrt(2),smo),{'Color',ColorPSTH{3},'Linewidth',2},1);

            H=shadedErrorBar(t4/1E3,SmoothDec(m4,smo),SmoothDec(s4/sqrt(2),smo),{'Color',ColorPSTH{2},'Linewidth',2},1);
            H=shadedErrorBar(t5/1E3,SmoothDec(m5,smo),SmoothDec(s5/sqrt(2),smo),{'Color',ColorPSTH{3},'Linewidth',2},1);
            H=shadedErrorBar(t6/1E3,SmoothDec(m6,smo),SmoothDec(s6/sqrt(2),smo),{'Color',ColorPSTH{2},'Linewidth',2},1);
            H=shadedErrorBar(t7/1E3,SmoothDec(m7,smo),SmoothDec(s7/sqrt(2),smo),{'Color',ColorPSTH{3},'Linewidth',2},1);

            yl=ylim;
            line([0 0],yl,'color',[0.7 0.7 0.7])
            line([30 30],yl,'color',[0.7 0.7 0.7])
            line([45 45],yl,'color',[0.7 0.7 0.7],'LineStyle','-')
            %ylim([0 20])
            xlim([-30 80])
            title(Dir.path{man}(ind_mark(end-1):end))
            plot([0 45],[20 20],'Color',[0.5 0.5 0.5],'LineStyle','--')
            
        if man<length(Dir.path)
            if strcmp(Dir.name{man+1}(end-2:end),Dir.name{man}(end-2:end))% same mouse, following recording
            else
                i=i+1;
            end
        end
        

    end
    cd(res)
    if sav 
        for i=1:length(nameMice), 
            saveas(allfig(i), ['MovtsdPSTH_ChR2/' nameMice{i} '_PSTH_allCS+.fig'])
            set(allfig(i),'PaperPosition',[0 0 12 20])
            saveas(allfig(i), ['MovtsdPSTH_ChR2/' nameMice{i} '_PSTH_allCS+.png'])
        end
    end

end

save PSTHdata.mat C0 E0 P0 C1 E1 P1 C2 E2 P2 C3 E3 P3 C4 E4 P4 C5 E5 P5 C6 E6 P6 C7 E7 P7 smo lim bi
tsdType='Movtsd';
PlotPSTHmatrixChR2_2(t0,t1,t2,t3,t4,t5,t6,t7,C0,P0,E0,C1,P1,E1,C2,P2,E2,C3,P3,E3,C4,E4,P4,C5,E5,P5,C6,E6,P6,C7,E7,P7,unique(MouseListC),StepName,0,1,CSoption,tsdType) % PSTH
PlotPSTHmatrixChR2_2(t0,t1,t2,t3,t4,t5,t6,t7,C0,P0,E0,C1,P1,E1,C2,P2,E2,C3,P3,E3,C4,E4,P4,C5,E5,P5,C6,E6,P6,C7,E7,P7,unique(MouseListC),StepName,1,1,CSoption,tsdType) % zscore PSTH


% %%%%%%%%%%%%%%%%%%%%%%%%%%% AVERAGE PSTH by group Bulb/Sham
% plot by group

% CS- no laser
% CS- with laser
% CS+ no laser
% CS+ with laser
%ColorPSTH={ [0.7 0.7 1],[1 0 0],[0 0 1],[1 0.7 0.7]};% [1 0.5 0]
if strcmp(CSoption, 'AllCS avg2by2')
    ColorAvgPSTH={ [0.5 0.5 1],[1 0.5 0.5],[0 0 1],[1 0 0],[0 0 1],[1 0 0],[0 0 1],[1 0 0]};% [1 0.5 0]    
elseif strcmp(CSoption, '4firstCS not averaged')
    ColorAvgPSTH={ [0.5 0.5 1],[1 0.5 0.5],[0.5 0.5 1],[1 0.5 0.5],[0 0 1],[1 0 0],[0 0 1],[1 0 0]};% [1 0.5 0]
end
sav=0;
mean_or_raw='raw';
for i=1:2;
    if i==1
        mean_or_raw='mean'; text2plot='average n=4 mice';
    elseif i==2
        mean_or_raw='raw'; text2plot='individual data';
    end
    figure('Color',  [1 1 1])
    set(gcf, 'Position',[ 8  91  1819 887]);
    n=8; p=3; a=1;

    SP{a}=subplot(n,p,a); PlotAveragePSTHmatrixChR2(C0,ColorAvgPSTH{1},StepName{1}, 'CS- no laser',sav,mean_or_raw);a=a+1; title(StepName{1})
    SP{a}=subplot(n,p,a); PlotAveragePSTHmatrixChR2(P0,ColorAvgPSTH{1},StepName{2},'CS- no laser',sav,mean_or_raw);a=a+1;title(StepName{2})
    SP{a}=subplot(n,p,a); PlotAveragePSTHmatrixChR2(E0,ColorAvgPSTH{1},StepName{3},'CS- no laser',sav,mean_or_raw);a=a+1;title(StepName{3})

    SP{a}=subplot(n,p,a); PlotAveragePSTHmatrixChR2(C1,ColorAvgPSTH{2},StepName{1}, 'CS- with laser',sav,mean_or_raw);a=a+1;
    SP{a}=subplot(n,p,a); PlotAveragePSTHmatrixChR2(P1,ColorAvgPSTH{2},StepName{2},'CS- with laser',sav,mean_or_raw);a=a+1;
    SP{a}=subplot(n,p,a); PlotAveragePSTHmatrixChR2(E1,ColorAvgPSTH{2},StepName{3},'CS- with laser',sav,mean_or_raw);a=a+1;

    if strcmp(mean_or_raw,'mean')
        SP{a}=subplot(n,p,a); PlotAveragePSTHmatrixChR2(C2,ColorAvgPSTH{3},StepName{1}, 'CS+ no laser',sav,mean_or_raw);a=a+1;
        SP{a}=subplot(n,p,a); PlotAveragePSTHmatrixChR2(P2,ColorAvgPSTH{3},StepName{2},'CS+ no laser',sav,mean_or_raw);a=a+1;
        SP{a}=subplot(n,p,a); PlotAveragePSTHmatrixChR2(E2,ColorAvgPSTH{3},StepName{3},'CS+ no laser',sav,mean_or_raw);a=a+1;

        SP{a}=subplot(n,p,a); PlotAveragePSTHmatrixChR2(C3,ColorAvgPSTH{4},StepName{1}, 'CS+ with laser',sav,mean_or_raw);a=a+1;
        SP{a}=subplot(n,p,a); PlotAveragePSTHmatrixChR2(P3,ColorAvgPSTH{4},StepName{2},'CS+ with laser',sav,mean_or_raw);a=a+1;
        SP{a}=subplot(n,p,a); PlotAveragePSTHmatrixChR2(E3,ColorAvgPSTH{4},StepName{3},'CS+ with laser',sav,mean_or_raw);a=a+1;
    elseif strcmp(mean_or_raw,'raw')
                SP{a}=subplot(n,p,a); PlotAveragePSTHmatrixChR2(C2,ColorAvgPSTH{3},StepName{1}, 'CS- no laser',sav,mean_or_raw);a=a+1;
        SP{a}=subplot(n,p,a); PlotAveragePSTHmatrixChR2(P2,ColorAvgPSTH{3},StepName{2},'CS- no laser',sav,mean_or_raw);a=a+1;
        SP{a}=subplot(n,p,a); PlotAveragePSTHmatrixChR2(E2,ColorAvgPSTH{3},StepName{3},'CS- no laser',sav,mean_or_raw);a=a+1;

        SP{a}=subplot(n,p,a); PlotAveragePSTHmatrixChR2(C3,ColorAvgPSTH{4},StepName{1}, 'CS- with laser',sav,mean_or_raw);a=a+1;
        SP{a}=subplot(n,p,a); PlotAveragePSTHmatrixChR2(P3,ColorAvgPSTH{4},StepName{2},'CS- with laser',sav,mean_or_raw);a=a+1;
        SP{a}=subplot(n,p,a); PlotAveragePSTHmatrixChR2(E3,ColorAvgPSTH{4},StepName{3},'CS- with laser',sav,mean_or_raw);a=a+1;
    end

    SP{a}=subplot(n,p,a); PlotAveragePSTHmatrixChR2(C4,ColorAvgPSTH{5},StepName{1}, 'CS+ no laser',sav,mean_or_raw);a=a+1;
    SP{a}=subplot(n,p,a); PlotAveragePSTHmatrixChR2(P4,ColorAvgPSTH{5},StepName{2},'CS+ no laser',sav,mean_or_raw);a=a+1;
    SP{a}=subplot(n,p,a); PlotAveragePSTHmatrixChR2(E4,ColorAvgPSTH{5},StepName{3},'CS+ no laser',sav,mean_or_raw);a=a+1;

    SP{a}=subplot(n,p,a); PlotAveragePSTHmatrixChR2(C5,ColorAvgPSTH{6},StepName{1}, 'CS+ with laser',sav,mean_or_raw);a=a+1;
    SP{a}=subplot(n,p,a); PlotAveragePSTHmatrixChR2(P5,ColorAvgPSTH{6},StepName{2},'CS+ with laser',sav,mean_or_raw);a=a+1;
    SP{a}=subplot(n,p,a); PlotAveragePSTHmatrixChR2(E5,ColorAvgPSTH{6},StepName{3},'CS+ with laser',sav,mean_or_raw);a=a+1;

    SP{a}=subplot(n,p,a); PlotAveragePSTHmatrixChR2(C6,ColorAvgPSTH{7},StepName{1}, 'CS+ no laser',sav,mean_or_raw);a=a+1;
    SP{a}=subplot(n,p,a); PlotAveragePSTHmatrixChR2(P6,ColorAvgPSTH{7},StepName{2},'CS+ no laser',sav,mean_or_raw);a=a+1;
    SP{a}=subplot(n,p,a); PlotAveragePSTHmatrixChR2(E6,ColorAvgPSTH{7},StepName{3},'CS+ no laser',sav,mean_or_raw);a=a+1;

    SP{a}=subplot(n,p,a); PlotAveragePSTHmatrixChR2(C7,ColorAvgPSTH{8},StepName{1}, 'CS+ with laser',sav,mean_or_raw);a=a+1;
    SP{a}=subplot(n,p,a); PlotAveragePSTHmatrixChR2(P7,ColorAvgPSTH{8},StepName{2},'CS+ with laser',sav,mean_or_raw);a=a+1;
    SP{a}=subplot(n,p,a); PlotAveragePSTHmatrixChR2(E7,ColorAvgPSTH{8},StepName{3},'CS+ with laser',sav,mean_or_raw);a=a+1;

    a_final=a-1;
    for aa=1:a_final
        subplot(SP{aa}), 
        ylim([0 20])
    end
    
    subplot(SP{1})
    text(-0.3,1.3,text2plot,'units','normalized')
    text(-0.3,1.5,CSoption,'units','normalized')
    
    set(gcf,'PaperPosition',[ 0  0 27 18])
    if i==1
        saveas(gcf,'FigBilanChR2FreezingChR2_AvgPSTHmatrix.fig')
        saveas(gcf,'FigBilanChR2FreezingChR2_AvgPSTHmatrix.png')
        
    elseif i==2
        saveas(gcf,'FigBilanChR2FreezingChR2_indivPSTHmatrix.fig')
        saveas(gcf,'FigBilanChR2FreezingChR2_indivPSTHmatrix.png')
        subplot(SP{1}), legend({'363','367','458','459'})
        
    end
end
    
if 0
    %%%%%% PSTH : comparison PRE/ DURING sound
    figure('Color',  [1 1 1])
    set(gcf, 'Position',[ 8  91  1819 887]);
    PreSound=[35:49]; % 15sec before sound
    Sound=[51:80]; % 15sec before sound
    subplot(3,3,1),BarPlotPrePost(C2,PreSound,Sound,ind_sham,ind_bulb), title([StepName{2} ' Pre -15 0   Post  0  30']), ylabel('cs+ (1-4)'), %xlabel('Pre -15 0   Post  0  30'),
    subplot(3,3,2),BarPlotPrePost(P2,PreSound,Sound,ind_sham,ind_bulb),title(StepName{3})
    subplot(3,3,3),BarPlotPrePost(E2,PreSound,Sound,ind_sham,ind_bulb),title(StepName{4})

    subplot(3,3,4),BarPlotPrePost(C3,PreSound,Sound,ind_sham,ind_bulb),ylabel('cs+ (5-end)')
    subplot(3,3,5),BarPlotPrePost(P3,PreSound,Sound,ind_sham,ind_bulb)
    subplot(3,3,6),BarPlotPrePost(E3,PreSound,Sound,ind_sham,ind_bulb)

    subplot(3,3,7),BarPlotPrePost(C1,PreSound,Sound,ind_sham,ind_bulb),ylabel('cs-'),
    subplot(3,3,8),BarPlotPrePost(P1,PreSound,Sound,ind_sham,ind_bulb)
    subplot(3,3,9),BarPlotPrePost(E1,PreSound,Sound,ind_sham,ind_bulb)
    %set(gca, 'XTick', [1 2 3 4 ],'XTickLabel', {'sham Pre', 'sham Post', 'bulb Pre', 'bulb Post'} )
    if sav
        set(gcf,'PaperPosition', [1 1 28 21])
        saveas (gcf, 'MvtPrePostSound.fig')
        saveas (gcf, 'MvtPrePostSound.png')
    end
end

% 
% function BarPlotPrePost(matrix, PreSound, Sound,ind_sham,ind_bulb)
%     PlotErrorbar4(nanmean(matrix(PreSound,ind_sham))',nanmean(matrix(Sound,ind_sham))',nanmean(matrix(PreSound,ind_bulb))',nanmean(matrix(Sound,ind_bulb))',0,2)
%     
%     [p_sham,h]=ranksum(nanmean(matrix(PreSound,ind_sham))',nanmean(matrix(Sound,ind_sham))');
%     max=YLim;
%     if p_sham<0.05
%         colorp='r';
%     else
%         colorp='k';
%     end
%     text(2,0.9*max(2),sprintf('%.2f',(p_sham)),'Color',colorp)
%     [p_bulb,h]=ranksum(nanmean(matrix(PreSound,ind_bulb))',nanmean(matrix(Sound,ind_bulb))');
%     if p_bulb<0.05
%         colorp='r';
%     else
%         colorp='k';
%     end
%     text(4,0.9*max(2),sprintf('%.2f',(p_bulb)),'Color',colorp) 
%     set(gca, 'XTick', [1 2 3 4 ],'XTickLabel', {'sham Pre', 'sham Post', 'bulb Pre', 'bulb Post'} )
%     %set(gca, 'XTick', [])
% end
% 



