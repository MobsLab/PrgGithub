clear all

Dir.path{1} ='D:\SophieToCopy\_media_DataMOBsRAID_ProjetAversion_DATA-Fear_Mouse248_20150326-EXT-24h-envC\20150326-EXT-24h-envC';
Dir.path{2} ='D:\SophieToCopy\_media_DataMOBsRAID_ProjetAversion_DATA-Fear_Mouse244_20150507-EXT-24h-envB\20150507-EXT-24h-envB';
Dir.path{3} ='D:\SophieToCopy\_media_DataMOBsRAID_ProjetAversion_DATA-Fear_Mouse244_20150507-EXT-24h-envB\20150507-EXT-24h-envB';
Dir.path{4} ='D:\SophieToCopy\_media_DataMOBsRAID_ProjetAversion_DATA-Fear_Mouse243_20150507-EXT-24h-envB\20150507-EXT-24h-envB';
Dir.path{5} ='D:\SophieToCopy\_media_DataMOBsRAID_ProjetAversion_DATA-Fear_Mouse253_20150703-EXT-24h-envC_FEAR-Mouse-253-03072015\FEAR-Mouse-253-03072015';
Dir.path{6} ='D:\SophieToCopy\_media_DataMOBsRAID_ProjetAversion_DATA-Fear_Mouse254_20150703-EXT-24h-envC\20150703-EXT-24h-envC';
Dir.path{7} ='D:\SophieToCopy\_media_DataMOBsRAID_ProjetAversion_DATA-Fear_Mouse258_20151204-EXT-24h-envC\20151204-EXT-24h-envC';
Dir.path{8} ='D:\SophieToCopy\_media_DataMOBsRAID_ProjetAversion_DATA-Fear_Mouse259_20151204-EXT-24h-envC\20151204-EXT-24h-envC';
Dir.path{9} ='D:\SophieToCopy\_media_DataMOBsRAID_ProjetAversion_DATA-Fear_Mouse299_20151217-EXT-24h-envC\20151217-EXT-24h-envC';
Dir.path{10} ='D:\SophieToCopy\_media_DataMOBsRAIDN_ProjetAversion_DATA-Fear_Mouse394_FEAR-Mouse-394-EXT-24-envBraye_161020_163239_\FEAR-Mouse-394-EXT-24-envBraye_161020_163239';
Dir.path{11} ='D:\SophieToCopy\_media_DataMOBsRAIDN_ProjetAversion_DATA-Fear_Mouse395_FEAR-Mouse-395-EXT-24-envBraye_161020_155350_\FEAR-Mouse-395-EXT-24-envBraye_161020_155350';
Dir.path{12} ='D:\SophieToCopy\_media_DataMOBsRAIDN_ProjetAversion_DATA-Fear_Mouse402_FEAR-Mouse-402-EXT-24-envB_raye_161026_164106_\FEAR-Mouse-402-EXT-24-envB_raye_161026_164106';
Dir.path{13} ='D:\SophieToCopy\_media_DataMOBsRAIDN_ProjetAversion_DATA-Fear_Mouse403_FEAR-Mouse-403-EXT-24-envB_raye_161026_171611_\FEAR-Mouse-403-EXT-24-envB_raye_161026_171611';
Dir.path{14} ='D:\SophieToCopy\_media_DataMOBsRAIDN_ProjetAversion_DATA-Fear_Mouse450_FEAR-Mouse-450-EXT-24-envB_161026_174952_\FEAR-Mouse-450-EXT-24-envB_161026_174952';
Dir.path{15} ='D:\SophieToCopy\_media_DataMOBsRAIDN_ProjetAversion_DATA-Fear_Mouse451_FEAR-Mouse-451-EXT-24-envB_161026_182307_\FEAR-Mouse-451-EXT-24-envB_161026_182307';

DirB.path{1} ='D:\SophieToCopy\_media_DataMOBsRAID_ProjetAversion_DATA-Fear_Mouse291_20151204-EXT-24h-envC\20151204-EXT-24h-envC';
DirB.path{2} ='D:\SophieToCopy\_media_DataMOBsRAID_ProjetAversion_DATA-Fear_Mouse297_20151217-EXT-24h-envC\20151217-EXT-24h-envC';
DirB.path{3} ='D:\SophieToCopy\_media_DataMOBsRAID_ProjetAversion_DATA-Fear_Mouse298_20151217-EXT-24h-envC\20151217-EXT-24h-envC';

% clear all

% Dir.path{1} ='D:\SophieToCopy\_media_DataMOBsRAID_ProjetAversion_DATA-Fear_Mouse244_20150506-EXT-24h-envC\20150506-EXT-24h-envC';
% Dir.path{2} ='D:\SophieToCopy\_media_DataMOBsRAID_ProjetAversion_DATA-Fear_Mouse253_20150703-EXT-24h-envC_FEAR-Mouse-253-03072015\FEAR-Mouse-253-03072015';
% Dir.path{3} ='D:\SophieToCopy\_media_DataMOBsRAID_ProjetAversion_DATA-Fear_Mouse254_20150703-EXT-24h-envC\20150703-EXT-24h-envC';
% Dir.path{4} ='D:\SophieToCopy\_media_DataMOBsRAID_ProjetAversion_DATA-Fear_Mouse258_20151204-EXT-24h-envC\20151204-EXT-24h-envC';
% Dir.path{5} ='D:\SophieToCopy\_media_DataMOBsRAID_ProjetAversion_DATA-Fear_Mouse259_20151204-EXT-24h-envC\20151204-EXT-24h-envC';
% Dir.path{6} = 'D:\SophieToCopy\_media_DataMOBsRAID_ProjetAversion_DATA-Fear_Mouse299_20151217-EXT-24h-envC\20151217-EXT-24h-envC';
% Dir.path{7} = 'D:\SophieToCopy\_media_DataMOBsRAIDN_ProjetAversion_DATA-Fear_Mouse394_FEAR-Mouse-394-EXT-24-envBraye_161020_163239_\FEAR-Mouse-394-EXT-24-envBraye_161020_163239';
% Dir.path{8} = 'D:\SophieToCopy\_media_DataMOBsRAIDN_ProjetAversion_DATA-Fear_Mouse395_FEAR-Mouse-395-EXT-24-envBraye_161020_155350_\FEAR-Mouse-395-EXT-24-envBraye_161020_155350';
% Dir.path{9} ='D:\SophieToCopy\_media_DataMOBsRAIDN_ProjetAversion_DATA-Fear_Mouse402_FEAR-Mouse-402-EXT-24-envB_raye_161026_164106_\FEAR-Mouse-402-EXT-24-envB_raye_161026_164106';
% Dir.path{10} ='D:\SophieToCopy\_media_DataMOBsRAIDN_ProjetAversion_DATA-Fear_Mouse403_FEAR-Mouse-403-EXT-24-envB_raye_161026_171611_\FEAR-Mouse-403-EXT-24-envB_raye_161026_171611';
% Dir.path{11} ='D:\SophieToCopy\_media_DataMOBsRAIDN_ProjetAversion_DATA-Fear_Mouse450_FEAR-Mouse-450-EXT-24-envB_161026_174952_\FEAR-Mouse-450-EXT-24-envB_161026_174952';
% Dir.path{12} ='D:\SophieToCopy\_media_DataMOBsRAIDN_ProjetAversion_DATA-Fear_Mouse451_FEAR-Mouse-451-EXT-24-envB_161026_182307_\FEAR-Mouse-451-EXT-24-envB_161026_182307';
% Dir.path{13} ='D:\SophieToCopy\_media_DataMOBsRAID_ProjetAversion_DATA-Fear_Mouse248_20150326-EXT-24h-envC\20150326-EXT-24h-envC';
% Dir.path{14} ='D:\SophieToCopy\_media_DataMOBsRAID_ProjetAversion_DATA-Fear_Mouse243_20150507-EXT-24h-envB\20150507-EXT-24h-envB';
% 
% DirB.path{1} ='D:\SophieToCopy\_media_DataMOBsRAID_ProjetAversion_DATA-Fear_Mouse291_20151204-EXT-24h-envC\20151204-EXT-24h-envC';
% DirB.path{2} ='D:\SophieToCopy\_media_DataMOBsRAID_ProjetAversion_DATA-Fear_Mouse297_20151217-EXT-24h-envC\20151217-EXT-24h-envC';
% DirB.path{3} ='D:\SophieToCopy\_media_DataMOBsRAID_ProjetAversion_DATA-Fear_Mouse298_20151217-EXT-24h-envC\20151217-EXT-24h-envC';
% 
neur = 1;
MeanSpecWk = [];
MeanSpecStr = [];
AllDur = [];
AllPow = [];
for k = 1:length(Dir.path)
    cd(Dir.path{k})
    
    if exist('SpikeData.mat')>0
        clear FreezeAccEpoch Kappa mu pval S
        [numNeurons, numtt, TT]=GetSpikesFromStructure('PFCx', 'remove_MUA',1);
        load('SpikeData.mat')
        S = S(numNeurons);
        load('behavResources.mat')
        if exist('FreezeAccEpoch')
            FreezeEpoch = FreezeAccEpoch;
        end
        TotEpoch = intervalSet(0,max(Range(Movtsd)));
        load('NeuronLFPCoupling_OB4HzPaper\AllEpochNeuronModFreqMiniMaxiPhaseCorrected_OB1.mat')

        
        clear Spectro Sptsd
        load('PFCx_Low_Spectrum.mat')
        
                [Coh,t,f] = LoadCohgramML('Bulb_deep','PFCx_deep');
        Spectro{1} = Coh; Spectro{2} = t; Spectro{3}=f;

        Sptsd = tsd(Spectro{2}*1E4,Spectro{1})
        clear PowRatio Spec Dur
        Lims = [find(Spectro{3}>2,1,'first'):find(Spectro{3}>6,1,'first')];
        for ep = 1:length(Start(FreezeEpoch))
%             LitEp = subset(FreezeEpoch,ep);
            LitEp = intervalSet(Stop(subset(FreezeEpoch,ep))-2*1E4,Stop(subset(FreezeEpoch,ep)));
            Spec(ep,:) = nanmean(Data(Restrict(Sptsd,LitEp)));
            PowRatio1(ep) = nanmean(Spec(ep,Lims));%/nanmean(Spec(ep,Lims(end):end));
            Dur(ep) = Stop(LitEp,'s') - Start(LitEp,'s');
            LitEp = intervalSet(Start(subset(FreezeEpoch,ep)),Start(subset(FreezeEpoch,ep))+2*1E4);
            Spec(ep,:) = nanmean(Data(Restrict(Sptsd,LitEp)));
            PowRatio2(ep) = nanmean(Spec(ep,Lims));%/nanmean(Spec(ep,Lims(end):end));
            PowRatio(ep) = PowRatio1(ep)./PowRatio2(ep);
            
        end
        MeanSpecStr = [MeanSpecStr;nanmean(Spec(find(zscore(PowRatio)>0),:))];
        MeanSpecWk = [MeanSpecWk;nanmean(Spec(find(zscore(PowRatio)<0),:))];
        AllDur = [AllDur,Dur];
        AllPow = [AllPow,(PowRatio)];

        for num = 1:length(S)
            [StartResp(neur,:), B] = CrossCorr(Start(FreezeEpoch),Range(S{num}),20,250);
            [StopResp(neur,:), B] = CrossCorr(Stop(FreezeEpoch),Range(S{num}),20,250);
            
            [StartRespHi(neur,:), B] = CrossCorr(Start(subset(FreezeEpoch,find((PowRatio)>1))),Range(S{num}),20,250);
            [StopRespHi(neur,:), B] = CrossCorr(Stop(subset(FreezeEpoch,find((PowRatio)>1))),Range(S{num}),20,250);

            [StartRespLo(neur,:), B] = CrossCorr(Start(subset(FreezeEpoch,find((PowRatio)<1))),Range(S{num}),20,250);
            [StopRespLo(neur,:), B] = CrossCorr(Stop(subset(FreezeEpoch,find((PowRatio)<1))),Range(S{num}),20,250);

            NumGoodEp(neur,:) = sum((PowRatio)>1);
            NumBadEp(neur,:) = sum((PowRatio)<1);
            
            [~,MeanNoFz(neur)] = FiringRateEpoch(S{num},TotEpoch-FreezeEpoch);
            [~,MeanFz(neur)] = FiringRateEpoch(S{num},FreezeEpoch);
            KappaNeur(neur) = Kappa{num};
            PhaseNeur(neur) = mu{num};
            PValNeur(neur) = pval{num};
            
            
            
            
            neur = neur+1;
        end
        
        
    end
    
end


MidVal = find(B>=0,1,'first')-1;

% look at 3 types of response
clear DatMatCl DatMat
DatMat = (([StartRespLo,StopRespLo,StartRespHi,StopRespHi]')');
for neur = 1:size(DatMat,1)
    MeanNoFz(neur) = nanmean(DatMat(neur,[1:50,450:500]));
    MeanFz(neur) = nanmean(DatMat(neur,[150:325]));
    Skeletton1 = [ones(1,MidVal)*MeanNoFz(neur),ones(1,MidVal*2+2)*MeanFz(neur),ones(1,MidVal)*MeanNoFz(neur)];
    MeanNoFz(neur) = nanmean(DatMat(neur,[500:550,950:1000]));
    MeanFz(neur) = nanmean(DatMat(neur,[650:825]));
    Skeletton2 = [ones(1,MidVal)*MeanNoFz(neur),ones(1,MidVal*2+2)*MeanFz(neur),ones(1,MidVal)*MeanNoFz(neur)];
    Skeletton = [Skeletton1,Skeletton2];
    DatMatCl(neur,:) =  DatMat(neur,:)-Skeletton;
end


DatMatClZ = zscore(DatMatCl')';
ValsToSort = nanmean(DatMatClZ(:,375:400)');
[val,ind] = sort(ValsToSort);
imagesc(DatMatClZ(ind,:)), caxis([-2 2])


% OnsetLo = nanmean(abs(DatMatClZ([PValNeur.Transf]>0.05,125:150)'));
% OnsetHi = nanmean(abs(DatMatClZ([PValNeur.Transf]>0.05,625:650)'));
% 
% OffsetLo = nanmean(abs(DatMatClZ([PValNeur.Transf]>0.05,375:400)'));
% OffsetHi = nanmean(abs(DatMatClZ([PValNeur.Transf]>0.05,875:900)'));
% 
% OnsetLoM = nanmean(abs(DatMatClZ([PValNeur.Transf]<0.05,125:150)'));
% OnsetHiM = nanmean(abs(DatMatClZ([PValNeur.Transf]<0.05,625:650)'));
% 
% OffsetLoM = nanmean(abs(DatMatClZ([PValNeur.Transf]<0.05,375:400)'));
% OffsetHiM = nanmean(abs(DatMatClZ([PValNeur.Transf]<0.05,875:900)'));
NumGoodEp=NumGoodEp';
NumBadEp=NumBadEp';

LimNum = 10;
OnsetLo = range((DatMatClZ([PValNeur.Transf]>0.05 & NumGoodEp>LimNum & NumBadEp>LimNum,125:150)'));
OnsetHi = range((DatMatClZ([PValNeur.Transf]>0.05 & NumGoodEp>LimNum & NumBadEp>LimNum,625:650)'));

OffsetLo = range((DatMatClZ([PValNeur.Transf]>0.05 & NumGoodEp>LimNum & NumBadEp>LimNum,375:400)'));
OffsetHi = range((DatMatClZ([PValNeur.Transf]>0.05 & NumGoodEp>LimNum & NumBadEp>LimNum,875:900)'));

OnsetLoM = range((DatMatClZ([PValNeur.Transf]<0.05 & NumGoodEp>LimNum & NumBadEp>LimNum,125:150)'));
OnsetHiM = range((DatMatClZ([PValNeur.Transf]<0.05 & NumGoodEp>LimNum & NumBadEp>LimNum,625:650)'));

OffsetLoM = range((DatMatClZ([PValNeur.Transf]<0.05 & NumGoodEp>LimNum & NumBadEp>LimNum,375:400)'));
OffsetHiM = range((DatMatClZ([PValNeur.Transf]<0.05 & NumGoodEp>LimNum & NumBadEp>LimNum,875:900)'));

% % MakeSpreadAndBoxPlot_SB({OnsetLo,OffsetLo,OnsetHi,OffsetHi},...
% %     {[0.5 0.5 0.5],[1 0.4 0.4],[0.5 0.5 0.5],[1 0.4 0.4]},[1,2,4,5]+6,{'OnLow','OffLow','OnHigh','OffHigh'},0)
clf

subplot(211)
MakeSpreadAndBoxPlot_SB({OnsetLo./OffsetLo,OnsetHi./OffsetHi,OnsetLoM./OffsetLoM,OnsetHiM./OffsetHiM},...
    {[0.5 0.5 0.5],[1 0.4 0.4],[0.5 0.5 0.5],[1 0.4 0.4]},[1,2,4,5],{'NonMod-Low','NonMod-High','Mod-Low','Mod-High'},0)

subplot(212)
MakeSpreadAndBoxPlot_SB({GetModIndex(OffsetLo,OnsetLo),GetModIndex(OffsetHi,OnsetHi),GetModIndex(OffsetLoM,OnsetLoM),GetModIndex(OffsetHiM,OnsetHiM)},...
    {[0.5 0.5 0.5],[1 0.4 0.4],[0.5 0.5 0.5],[1 0.4 0.4]},[1,2,4,5],{'NonMod-Low','NonMod-High','Mod-Low','Mod-High'},0)

