clear all,
AllFearData={'ManipFeb15Bulbectomie',...
    'FearCBNov15'};
GrpName={'CTRL','OBX'};
close all
for grp=1:2
    
n=1;
for ss=1:2
    Dir=PathForExperimentFEAR(AllFearData{ss},'fear',1);
    DirR = RestrictPathForExperiment(Dir,'Group',GrpName{grp});
    DirR = RestrictPathForExperiment(DirR,'Session',{'COND'});
    
    for mm=1:size(DirR.path,2)
        try
            cd(DirR.path{mm})
            load('Behavior.mat')
            if exist('TTL','var')
                % Get CSPlusBlock beginnings
                Shocks=TTL(find(TTL(:,2)==5),1);
                CSplu=TTL(find(TTL(:,2)==3),1);
                CSmoin=TTL(find(TTL(:,2)==4),1);
                if length(CSmoin)==215
                   CSmoin(216)=CSmoin(215)+1.1;
                end
                CSpluInd=reshape(CSplu,length(CSplu)/8,8);
                CSpluBegEnd=[CSpluInd(1,:);CSpluInd(end,:)];
                CSPlusEpoch=intervalSet(CSpluBegEnd(1,:)*1e4,CSpluBegEnd(2,:)*1e4);
                CSPlusEpochBrd=intervalSet(CSpluBegEnd(1,:)*1e4-10*1e4,CSpluBegEnd(2,:)*1e4);
                CSmoinInd=reshape(CSmoin,length(CSmoin)/8,8);
                CSmoinBegEnd=[CSmoinInd(1,:);CSmoinInd(end,:)];
                CSMoinsEpoch=intervalSet(CSmoinBegEnd(1,:)*1e4,CSmoinBegEnd(2,:)*1e4);
                CSMoinsEpochBrd=intervalSet(CSmoinBegEnd(1,:)*1e4-10*1e4,CSmoinBegEnd(2,:)*1e4);
                PostShockEpoch=intervalSet(Shocks*1e4,Shocks*1e4+30*1e4);
            else
                CSPlusEpoch=intervalSet(StimInfo(1:3:end-1,1)*1e4,StimInfo(1:3:end-1,1)*1e4+30*1e4);
                CSPlusEpochBrd=intervalSet(StimInfo(1:3:end-1,1)*1e4-10*1e4,StimInfo(1:3:end-1,1)*1e4+30*1e4);
                CSMoinsEpoch=intervalSet(StimInfo(3:3:end,1)*1e4,StimInfo(3:3:end,1)*1e4+30*1e4);
                CSMoinsEpochBrd=intervalSet(StimInfo(3:3:end,1)*1e4-10*1e4,StimInfo(3:3:end,1)*1e4+30*1e4);
                PostShockEpoch=intervalSet(StimInfo(2:3:end,1)*1e4+3*1e4,StimInfo(2:3:end,1)*1e4+30*1e4);
            end
            
            % Variables to get
            %Freezing during sounds
            %Mean speed during sounds
            %Mean speed during sounds outisde freezing
            %Movement triggered on sound onset
            %Movement just before sound
            for k=1:length(Start(CSPlusEpoch))
                Var{n,1}(k)=length(Data(Restrict(Movtsd,And(FreezeEpoch,subset(CSPlusEpoch,k)))))./length(Data(Restrict(Movtsd,subset(CSPlusEpoch,k))));
                Var{n,2}(k)=mean(Data(Restrict(Movtsd,subset(CSPlusEpoch,k))));
                Var{n,3}(k)=mean(Data(Restrict(Movtsd,And(FreezeEpoch,subset(CSPlusEpoch,k)))));
                dat=Data(Restrict(Movtsd,subset(CSPlusEpochBrd,k)));
                Var{n,4}(k,1:100)=dat(1:100);
            end
            
            %Freezing during sounds
            %Mean speed during sounds
            %Mean speed during sounds outisde freezing
            %Movement triggered on sound onset
            %Movement just before sound
            for k=1:length(Start(CSMoinsEpoch))
                Var{n,5}(k)=length(Data(Restrict(Movtsd,And(FreezeEpoch,subset(CSMoinsEpoch,k)))))./length(Data(Restrict(Movtsd,subset(CSMoinsEpoch,k))));
                Var{n,6}(k)=mean(Data(Restrict(Movtsd,subset(CSMoinsEpoch,k))));
                Var{n,7}(k)=mean(Data(Restrict(Movtsd,And(FreezeEpoch,subset(CSMoinsEpoch,k)))));
                dat=Data(Restrict(Movtsd,subset(CSMoinsEpochBrd,k)));
                Var{n,8}(k,:)=dat(1:100);
            end
            
            %Freezing after shock
            %Mean speed after sounds
            %Mean speed after sounds ouside freezing
            %Movement triggered on shock
            for k=1:length(Start(PostShockEpoch))
                Var{n,9}(k)=length(Data(Restrict(Movtsd,And(FreezeEpoch,subset(PostShockEpoch,k)))))./length(Data(Restrict(Movtsd,subset(PostShockEpoch,k))));
                Var{n,10}(k)=mean(Data(Restrict(Movtsd,subset(PostShockEpoch,k))));
                Var{n,11}(k)=mean(Data(Restrict(Movtsd,And(FreezeEpoch,subset(PostShockEpoch,k)))));
                dat=Data(Restrict(Movtsd,subset(PostShockEpoch,k)));
                Var{n,12}(k,:)=dat(1:70);
            end

            
            n=n+1;
            n
            
            clear TTL Movtsd StimInfo
        end
    end
    
end

AllP=reshape([Var{1:n-1,1}],8,n-1);
AllM=reshape([Var{1:n-1,5}],8,n-1);
AllAft=reshape([Var{1:n-1,9}],8,n-1);
subplot(311)
g=shadedErrorBar([1:8],mean(AllP'),[stdError(AllP');stdError(AllP')]), hold on
set(g.patch,'FaceColor',[1 0.2 0.2]*0.8^grp)
subplot(312)
g=shadedErrorBar([1:8],mean(AllM'),[stdError(AllM');stdError(AllM')]), hold on
set(g.patch,'FaceColor',[0.6 0.6 0.6]*0.8^grp)
subplot(313)
g=shadedErrorBar([1:8],mean(AllAft'),[stdError(AllAft');stdError(AllAft')]), hold on
set(g.patch,'FaceColor',[0.4 0.2 0.8]*0.8^grp)
ylim([0 0.7])


end